/*! ng-catwalk by Adam Timberlake <adam.timberlake@gmail.com> created on 2014-07-03 */
!function(a,b,c){"use strict";var d=a.module("ngCatwalk",["ngCrossfilter"]),e=function(a){throw"ngCatwalk: "+a+"."},f={any:function(b){return function(c){return null===c?null:a.isDefined(c)?c:b}},autoIncrement:function(){var a=0;return function(){return++a}},custom:function(a){return function(b){return a(b)}},number:function(b){return function(c){return null===c?null:a.isDefined(c)?+c:b}},string:function(b){return function(c){return null===c?b||null:a.isDefined(c)?String(c):b}}},g={TYPES:{ONE:"One",MANY:"Many"},One:function(a){this.getOptions=function(){return a}},Many:function(a){this.getOptions=function(){return a}}};d.service("catwalk",["$rootScope","$q","$interpolate","Crossfilter",function(d,h,i,j){function k(){this._collections={},this._relationships={},this._relationshipStore={}}return k.prototype={_collections:{},_primaryName:"_catwalkId",_relationshipStore:{},_relationships:{},_silent:!1,_eventName:"catwalk/{{type}}/{{collection}}",_relationshipName:"{{localCollection}}/{{localProperty}}/{{foreignCollection}}/{{foreignProperty}}",attribute:f,relationship:{hasOne:function(a){return new g[g.TYPES.ONE](a)},hasMany:function(a){return new g[g.TYPES.MANY](a)}},collection:function(a,b){return this._collections[a]||(this._collections[a]=new j([],this._primaryName)),b&&(b[this._primaryName]=this.attribute.number(),this._collections[a].blueprint=b,this._collections[a].index=0,this._collections[a].name=a,this._propertyIterator(b,function(b){this._collections[a].addDimension(b)})),this._collections[a]},silently:function(a){this._silent=!0,a.apply(this),this._silent=!1},createModel:function(a,b){b=this.cleanModel(a,b),this.collection(a).addModel(b);var c=this.simplifyModel(a,b),d=this.createPromise(a,"create",[c]);return d.then(this.resolveCreateModel(a,b).bind(this)),d.catch(this.rejectCreateModel(a,b).bind(this)),b},rejectCreateModel:function(a,b){return function(){this.silently(function(){this.collection(a).deleteModel(b)})}},resolveCreateModel:function(b,c){return function(d){var e=this.collection(b).blueprint;this._propertyIterator(d,function(b){var f=e[b];a.isDefined(f)&&(c[b]=f(d[b]))})}},updateModel:function(a,c,d){var e=b.extend(b.clone(c),d),f=c[this._primaryName];this._propertyIterator(e,function(b){this.getRelationshipType(a,b)&&(e[b]=this._relationshipStore[a][f][b])}),this.silently(function(){this.createModel(a,e),this.deleteModel(a,c)});var g=this.simplifyModel(a,e),h=this.createPromise(a,"update",[g]);return h.then(this.resolveUpdateModel(a,c,d).bind(this)),h.catch(this.rejectUpdateModel(a,c,e).bind(this)),c},simplifyModel:function(a,c){var d=b.clone(c),e=d[this._primaryName];return delete d[this._primaryName],delete d.$$hashKey,this._propertyIterator(d,function(b){this.getRelationshipType(a,b)&&(d[b]=this._relationshipStore[a][e][b])}),d},resolveUpdateModel:function(a,b,c){return function(){this.pruneRelationships(a,c)}},rejectUpdateModel:function(a,b,c){return function(){this.silently(function(){this.collection(a).restoreModel(b),this.deleteModel(a,c)})}},deleteModel:function(a,b){this.collection(a).deleteModel(b);var c=this.simplifyModel(a,b),d=this.createPromise(a,"delete",[c]);return d.then(this.resolveDeleteModel(a,b).bind(this)),d.catch(this.rejectDeleteModel(a,b).bind(this)),b},resolveDeleteModel:function(a,b){return function(){this.pruneRelationships(a,b)}},rejectDeleteModel:function(a,b){return function(){this.silently(function(){this.collection(a).restoreModel(b)})}},createPromise:function(a,c,e){var f=h.defer();b.isArray(e)||(e=e?[e]:[]),e.unshift(f);var g=i(this._eventName)({type:c,collection:a});return d.$broadcast(g,e[0],e[1],e[2]),f.promise},createRelationship:function(b,c,d){var e=this.collection(b),f=e.blueprint[d],h=f.getOptions(),j=this.collection(h.collection),k=this._relationshipStore,l=c[this._primaryName];(function(){var a={localCollection:b,localProperty:d,foreignCollection:h.collection,foreignProperty:h.foreignKey},c=i(this._relationshipName)(a);this._relationships[c]=a}).bind(this)(),function(){a.isDefined(k[b])||(k[b]={}),a.isDefined(k[b][l])||(k[b][l]={})}();var m="throwRelationshipException";switch(this.getRelationshipType(b,d)){case g.TYPES.ONE:m="createHasOneRelationship";break;case g.TYPES.MANY:m="createHasManyRelationship"}this[m](b,c,d,j,h.foreignKey)},pruneRelationships:function(a,b){this._propertyIterator(this._relationships,function(c){var d=this._relationships[c];if(d.foreignCollection===a)for(var e=b[d.foreignProperty],f=this.collection(d.localCollection).collection(),h=this.getRelationshipType(d.localCollection,d.localProperty),i=0;i<f.length;i++)switch(h){case g.TYPES.ONE:f[i][d.localProperty]="";break;case g.TYPES.MANY:f[i][d.localProperty].remove(e)}})},throwRelationshipException:function(){e("Congratulations! You managed to create an invalid relationship")},createHasOneRelationship:function(a,b,d,e,f){var g=b[this._primaryName],h=this._relationshipStore,i=this.createPromise.bind(this);h[a][g][d]=b[d]||"",c.defineProperty(b,d,{get:function(){var b=h[a][g][d];e.filterBy(f,b);var c=e.collection()[0];return b.length&&0===e.length&&i(e.name,"read",[f,b]),e.unfilterBy(f),c||{}},set:function(b){h[a][g][d]=b}})},createHasManyRelationship:function(a,d,e,f,g){var h=d[this._primaryName],i=this._relationshipStore,j=this.createPromise.bind(this);i[a][h][e]=d[e]||[];var k=i[a][h][e],l=function(a,b){return-1!==a.indexOf(b)};c.defineProperty(d,e,{get:function(){f.filterBy(g,k,l);var a=f.collection();if(k.length&&a.length!==k.length){var c=b.pluck(a,g),d=b.difference(k,c);if(0!==c.length)for(var e=0;e<d.length;e++)j(f.name,"read",[g,d[e]])}return f.unfilterBy(g),a.add=function(b){a.has(b)||k.push(b)},a.remove=function(a){var b=k.indexOf(a);-1!==b&&k.splice(b,1)},a.clear=function(){k=[]},a.has=function(a){return-1!==k.indexOf(a)},a||[]},set:function(a){-1===k.indexOf(a)&&k.push(a)}})},cleanModel:function(b,c){var d=this._primaryName,e=this.collection(b).blueprint,f=this._propertyIterator,g=this.getRelationshipType.bind(this),h=this.createRelationship.bind(this);return c[d]=++this.collection(b).index,function(){f(c,function(a){e.hasOwnProperty(a)||delete c[a]})}(),function(){f(e,function(f){if(a.isDefined(c[f])||f===d||(c[f]=null),!g(b,f)){var i=e[f];return void(c[f]=i(c[f]))}h(b,c,f)})}(),c},getRelationshipType:function(a,b){var c=this.collection(a).blueprint[b],d={};d[g.TYPES.ONE]=g.One,d[g.TYPES.MANY]=g.Many;for(var e in d)if(d.hasOwnProperty(e)&&c instanceof d[e])return e;return null},_propertyIterator:function(a,b){for(var c in a)a.hasOwnProperty(c)&&b.call(this,c)}},new k}])}(window.angular,window._,window.Object);