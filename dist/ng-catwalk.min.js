/*! ng-catwalk by Adam Timberlake <adam.timberlake@gmail.com> created on 2014-06-30 */
!function(a,b){"use strict";var c=a.module("ngCatwalk",["ngCrossfilter"]),d={any:function(a){return function(b){return null===b?null:"undefined"!=typeof b?b:a}},autoIncrement:function(){var a=0;return function(){return++a}},number:function(a){return function(b){return null===b?null:"undefined"!=typeof b?+b:a}},string:function(a){return function(b){return null===b?a||null:"undefined"!=typeof b?String(b):a}}},e={One:function(a){this.getOptions=function(){return a}}};c.service("catwalk",["$rootScope","$q","$interpolate","Crossfilter",function(a,c,f,g){function h(){}return h.prototype={attribute:d,relationship:{hasOne:function(a){return new e.One(a)}},_primaryName:"_catwalkId",_relationshipStores:{},_silent:!1,_eventName:"catwalk/{{type}}/{{collection}}",_collections:{},collection:function(a,b){if(this._collections[a]||(this._collections[a]=new g([])),b){b[this._primaryName]=this.attribute.number(),this._collections[a].primaryKey(this._primaryName),this._collections[a].blueprint=b,this._collections[a].index=0;for(var c in b)b.hasOwnProperty(c)&&this._collections[a].addDimension(c)}return this._collections[a]},silently:function(a){this._silent=!0,a.apply(this),this._silent=!1},createModel:function(a,b){b=this.cleanModel(a,b),this.collection(a).addModel(b);var c=this.createPromise(a,"create",[b]);return c.then(this.resolveCreateModel(a,b).bind(this)),c.catch(this.rejectCreateModel(a,b).bind(this)),b},rejectCreateModel:function(a,b){return function(){this.silently(function(){this.collection(a).deleteModel(b)})}},resolveCreateModel:function(a,b){return function(c){var d=this.collection(a).blueprint;this._propertyIterator(c,function(a){var e=d[a];"undefined"!=typeof e&&(b[a]=e(c[a]))})}},updateModel:function(){},resolveUpdateModel:function(){},rejectUpdateModel:function(){},deleteModel:function(a,b){this.collection(a).deleteModel(b);var c=this.createPromise(a,"delete",[b]);return c.then(this.resolveDeleteModel(a,b).bind(this)),c.catch(this.rejectDeleteModel(a,b).bind(this)),b},resolveDeleteModel:function(){return function(){}},rejectDeleteModel:function(a,b){return function(){this.silently(function(){this.collection(a).restoreModel(b)})}},createPromise:function(b,d,e){var g=c.defer();Array.isArray(e)||(e=e?[e]:[]),e.unshift(g);var h=f(this._eventName)({type:d,collection:b});return a.$broadcast(h,e[0],e[1],e[2]),g.promise},createHasManyRelationship:function(){},createHasOneRelationship:function(){},cleanModel:function(a,b){var c=this._primaryName,d=this.collection(a).blueprint,e=this._propertyIterator,f=this.isRelationship.bind(this),g=this.createRelationship.bind(this);return b[c]=++this.collection(a).index,function(){e(b,function(a){d.hasOwnProperty(a)||delete b[a]})}(),function(){e(d,function(e){if("undefined"==typeof b[e]&&e!==c&&(b[e]=null),!f(a,e)){var h=d[e];return void(b[e]=h(b[e]))}g(a,b,e)})}(),b},createRelationship:function(a,c,d){var e=this.collection(a),f=e.blueprint[d].getOptions(),g=this.collection(f.collection),h=this._relationshipStores,i=c[this._primaryName];"undefined"==typeof h[i]&&(h[i]={}),h[i][d]=c[d]||"",b.defineProperty(c,d,{get:function(){g.filterBy(f.foreignKey,h[i][d]);var a=g[0];return g.unfilterAll(),a},set:function(a){h[i][d]=a}})},isRelationship:function(a,b){var c=this.collection(a).blueprint[b],d=[e.One];for(var f in d)if(d.hasOwnProperty(f)&&c instanceof d[f])return!0;return!1},_propertyIterator:function(a,b){for(var c in a)a.hasOwnProperty(c)&&b.call(this,c)}},new h}])}(window.angular,window.Object);