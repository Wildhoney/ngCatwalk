/*! ng-catwalk by Adam Timberlake <adam.timberlake@gmail.com> created on 2014-07-03 */
!function(a,b,c){"use strict";var d=a.module("ngCatwalk",["ngCrossfilter"]),e=function(a){throw"ngCatwalk: "+a+"."},f={any:function(b){return function(c){return null===c?null:a.isDefined(c)?c:b}},autoIncrement:function(){var a=0;return function(b){return null!==b?b:++a}},custom:function(a){return function(b){return a(b)}},number:function(b){return function(c){return null===c?null:a.isDefined(c)?+c:b}},string:function(b){return function(c){return null===c?b||null:a.isDefined(c)?String(c):b}}},g={TYPES:{ONE:"One",MANY:"Many"},One:function(a){this.getOptions=function(){return a}},Many:function(a){this.getOptions=function(){return a}}};d.service("catwalk",["$rootScope","$q","$interpolate","Crossfilter",function(d,h,i,j){function k(){this.collections={},this.relationships={},this.relationshipStore={},this.deferStore={}}return k.prototype={mode:"instant",collections:{},primaryName:"_catwalkId",relationshipStore:{},deferStore:{},relationships:{},silent:!1,eventName:"catwalk/{{type}}/{{collection}}",deferName:"catwalk/defer/{{collection}}/{{property}}/{{value}}",relationshipName:"{{localCollection}}/{{localProperty}}/{{foreignCollection}}/{{foreignProperty}}",attribute:f,relationship:{hasOne:function(a){return new g[g.TYPES.ONE](a)},hasMany:function(a){return new g[g.TYPES.MANY](a)}},collection:function(a,b){return this.collections[a]||(this.collections[a]=new j([],this.primaryName)),b&&(b[this.primaryName]=this.attribute.number(),this.collections[a].blueprint=b,this.collections[a].index=0,this.collections[a].name=a,this._propertyIterator(b,function(b){this.collections[a].addDimension(b)})),this.collections[a]},setMode:function(a){this.mode=a},silently:function(a){this.silent=!0,a.apply(this),this.silent=!1},createModel:function(a,b){b=this.cleanModel(a,b);var c=this.simplifyModel(a,b),d=this.createPromise(a,"create",[c]);return d.then(this.resolveCreateModel(a,b).bind(this)),d.catch(this.rejectCreateModel(a,b).bind(this)),b},resolveCreateModel:function(b,c){return function(d){var e=this.collection(b).blueprint;this._propertyIterator(d,function(b){var f=e[b];a.isDefined(f)&&(c[b]=f(d[b]))}),this.collection(b).addModel(c)}},rejectCreateModel:function(a,b){return function(){this.silently(function(){this.collection(a).deleteModel(b)})}},updateModel:function(a,c,d){var e=b.extend(b.clone(c),d),f=this.simplifyModel(a,e);console.log(JSON.stringify(f));var g=this.createPromise(a,"update",[f]);return g.catch(this.rejectUpdateModel(a,c,e).bind(this)),g.then(this.resolveUpdateModel(a,e,c,d).bind(this)),c},resolveUpdateModel:function(a,b,c,d){return function(){var e=c[this.primaryName];this._propertyIterator(b,function(c){this.relationshipType(a,c)&&(b[c]=this.relationshipStore[a][e][c])}),this.silently(function(){this.createModel(a,b),this.deleteModel(a,c)}),this.pruneRelationships(a,d)}},resolveReadModel:function(a){return function(b){this.silently(function(){this.createModel(a,b)})}},rejectUpdateModel:function(a,b,c){return function(){this.silently(function(){this.collection(a).restoreModel(b),this.deleteModel(a,c)})}},deleteModel:function(a,b){var c=this.simplifyModel(a,b),d=this.createPromise(a,"delete",[c]);return d.then(this.resolveDeleteModel(a,b).bind(this)),d.catch(this.rejectDeleteModel(a,b).bind(this)),b},resolveDeleteModel:function(a,b){return function(){this.collection(a).deleteModel(b),this.pruneRelationships(a,b)}},rejectDeleteModel:function(a,b){return function(){this.silently(function(){this.collection(a).restoreModel(b)})}},simplifyModel:function(a,c){var d=b.clone(c),e=d[this.primaryName];return delete d[this.primaryName],delete d.$$hashKey,this._propertyIterator(d,function(f){if(this.relationshipType(a,f)){var h=d[f];switch(d[f]=this.relationshipStore[a][e][f],this.relationshipType(a,f)){case g.TYPES.MANY:h[0]&&b.forEach(h,function(a,b){a[this.primaryName]===c[this.primaryName]&&d[f].splice(b,1)}.bind(this))}}}),d},createPromise:function(a,c,e){var f=h.defer();if(this.silent)return f.resolve(),f.promise;b.isArray(e)||(e=e?[e]:[]),e.unshift(f);var g=i(this.eventName)({type:c,collection:a});return d.$broadcast(g,e[0],e[1],e[2]),f.promise},createRelationship:function(b,c,d){var e=this.collection(b),f=e.blueprint[d],h=f.getOptions(),j=this.collection(h.collection),k=this.relationshipStore,l=c[this.primaryName];(function(){var a={localCollection:b,localProperty:d,foreignCollection:h.collection,foreignProperty:h.foreignKey},c=i(this.relationshipName)(a);this.relationships[c]=a}).bind(this)(),function(){a.isDefined(k[b])||(k[b]={}),a.isDefined(k[b][l])||(k[b][l]={})}();var m="throwRelationshipException";switch(this.relationshipType(b,d)){case g.TYPES.ONE:m="createHasOneRelationship";break;case g.TYPES.MANY:m="createHasManyRelationship"}this[m](b,c,d,j,h.foreignKey)},pruneRelationships:function(a,b){this._propertyIterator(this.relationships,function(c){var d=this.relationships[c];if(d.foreignCollection===a)for(var e=b[d.foreignProperty],f=this.collection(d.localCollection).collection(),h=this.relationshipType(d.localCollection,d.localProperty),i=0;i<f.length;i++)switch(h){case g.TYPES.ONE:f[i][d.localProperty]="";break;case g.TYPES.MANY:f[i][d.localProperty].remove(e)}})},throwRelationshipException:function(){e("Congratulations! You managed to create an invalid relationship")},createHasOneRelationship:function(a,b,d,e,f){var g=b[this.primaryName],h=this.relationshipStore,j=this.createPromise.bind(this);h[a][g][d]=b[d]||"",c.defineProperty(b,d,{get:function(){var b=h[a][g][d];e.filterBy(f,b);var c=e.collection()[0];if(b.length&&0===e.length){var k=i(this.deferName)({collection:e.name,property:f,value:b});if(!this.deferStore[k]){this.deferStore[k]=!0;var l=j(e.name,"read",[f,b]);this.silent||l.then(this.resolveReadModel(e.name).bind(this))}}return e.unfilterBy(f),c||{}}.bind(this),set:function(b){h[a][g][d]=b}})},createHasManyRelationship:function(a,d,e,f,g){var h=d[this.primaryName],j=this.relationshipStore,k=this.createPromise.bind(this);j[a][h][e]=d[e]||[];var l=j[a][h][e],m=function(a,b){return-1!==a.indexOf(b)};c.defineProperty(d,e,{get:function(){f.filterBy(g,l,m);var a=f.collection();if(l.length&&a.length!==l.length){var c=l,d=["ok"];if(a&&a.length&&(d=b.pluck(a,g),c=b.difference(l,d)),0!==d.length)for(var e=0;e<c.length;e++){var h=i(this.deferName)({collection:f.name,property:g,value:c[e]});if(!this.deferStore[h]){this.deferStore[h]=!0;var j=k(f.name,"read",[g,c[e]]);this.silent||j.then(this.resolveReadModel(f.name).bind(this))}}}return f.unfilterBy(g),a.add=function(b){a.has(b)||l.push(b)},a.remove=function(a){var b=l.indexOf(a);-1!==b&&l.splice(b,1)},a.clear=function(){l=[]},a.has=function(a){return-1!==l.indexOf(a)},a||[]}.bind(this),set:function(a){-1===l.indexOf(a)&&l.push(a)}})},cleanModel:function(b,c){var d=this.primaryName,e=this.collection(b).blueprint,f=this._propertyIterator,g=this.relationshipType.bind(this),h=this.createRelationship.bind(this);return c[d]=++this.collection(b).index,function(){f(c,function(a){e.hasOwnProperty(a)||delete c[a]})}(),function(){f(e,function(f){if(a.isDefined(c[f])||f===d||(c[f]=null),!g(b,f)){var i=e[f];return void(c[f]=i(c[f]))}h(b,c,f)})}(),c},relationshipType:function(a,b){var c=this.collection(a).blueprint[b],d={};d[g.TYPES.ONE]=g.One,d[g.TYPES.MANY]=g.Many;for(var e in d)if(d.hasOwnProperty(e)&&c instanceof d[e])return e;return null},_propertyIterator:function(a,b){for(var c in a)a.hasOwnProperty(c)&&b.call(this,c)}},new k}])}(window.angular,window._,window.Object);