/*! ng-catwalk by Adam Timberlake <adam.timberlake@gmail.com> created on 2014-06-24 */
!function(a){"use strict";var b=a.module("ngCatwalk",["ngCrossfilter"]),c=function(a){throw"ngCatwalk: "+a+"."},d=a.injector(["ngCatwalk","ng"]),e=d.get("$q"),f={hasMany:function(b){return function(c,d,f){var g=this._collections[b.collection],h={},i=c[d]||[],j=this.createModel.bind(this),k=f.rootScope,l=function(c,d){var e=[];return a.forEach(c,function(a){e.push(a)}),a.forEach(d,function(a){var c=a[b.foreignKey],d=e.indexOf(c);e.splice(d,1)}),e};Object.defineProperty(c,d,{get:function(){g.filterBy(b.foreignKey,i,function(a,b){return-1!==a.indexOf(b)});var c=g._collection(1/0);return g.unfilterBy(b.foreignKey),a.forEach(l(i,c),function(a){if("undefined"==typeof h[a]){var c=h[a]=e.defer();k.$broadcast("catwalk/read/"+b.collection,c,b.foreignKey,a),c.promise.then(function(a){j(b.collection,a)}),c.promise.catch(function(){var b=i.indexOf(a);i.splice(b,1)})}}),c._resolve=function(a){return"object"==typeof a?a[d]:a},c.addModel=function(a){i.push(c._resolve(a))},c.deleteModel=function(a){var b=i.indexOf(c._resolve(a));i.splice(b,1)},c.hasModel=function(a){return-1!==i.indexOf(c._resolve(a))},c},set:function(){}})}}},g={string:function(a){return function(b){return"undefined"==typeof b?this._default(a,""):String(b)}.bind(this)},autoincrement:function(){var a=0;return function(){return++a}.bind(this)},number:function(a){return function(b){return"undefined"==typeof b?this._default(a,0):Number(b)}.bind(this)},_default:function(a,b){return"undefined"==typeof a?b:a}};b.service("catwalk",["$rootScope","$q","Crossfilter",function(a,b,d){function e(){}return e.prototype={_primaryName:"__catwalkId__",_primaryIndex:0,_collections:{},attribute:g,relationship:f,collection:function(a,b){if(this._collections[a]||(this._collections[a]=new d([])),b){b[this._primaryName]=this.attribute.number(),this._collections[a].primaryKey(this._primaryName),this._collections[a].blueprint=b;for(var c in b)b.hasOwnProperty(c)&&this._collections[a].addDimension(c)}return this._collections[a]},createModel:function(a,b){var c=this._prepareModel(a,b);c[this._primaryName]=++this._primaryIndex,this.collection(a).addModel(c),this._awaitFeedback("create",a,c,function(){this._deleteModel(a,c)})},updateModel:function(a,b,c){var d={};for(var e in c)c.hasOwnProperty(e)&&(d[e]=b[e]);this._updateModel(a,b,c),this._awaitFeedback("update",a,b,function(){this._updateModel(a,b,d)})},_updateModel:function(a,b,d){var e=this._collections[a].blueprint;for(var f in d)if(d.hasOwnProperty(f)){var g=e[f];this._isRelationship(g)&&c("Cannot redefine a relationship"),b[f]=g(d[f])}},deleteModel:function(a,b){this._deleteModel(a,b),this._awaitFeedback("delete",a,b,function(){this.collection(a).restoreModel(b)})},_deleteModel:function(a,b){this.collection(a).deleteModel(b)},_isRelationship:function(a){return a.toString().match(/(HasManyRelationship|HasOneRelationship)/i)},_prepareModel:function(b,c){c=c||{};var d=this.collection(b).blueprint;for(var e in d)if(d.hasOwnProperty(e)){if("primaryKey"===e)continue;var f=d[e];if("undefined"==typeof c[e]&&(c[e]=void 0),this._isRelationship(f)){f.call(this,c,e,{rootScope:a});continue}c[e]=f(c[e])}for(var g in c)c.hasOwnProperty(g)&&"undefined"==typeof d[g]&&delete c[g];return c},_awaitFeedback:function(c,d,e,f){var g=b.defer();a.$broadcast("catwalk/"+c+"/"+d,g,e),g.promise.catch(function(){f.apply(this)}.bind(this))}},new e}])}(window.angular);