/*! ng-catwalk by Adam Timberlake <adam.timberlake@gmail.com> created on 2014-07-04 */
!function(a,b){"use strict";var c=a.module("ngCatwalk",["ngCrossfilter"]),d=function(a){throw"ngCatwalk: "+a+"."},e={any:function(b){return function(c){return null===c?null:a.isDefined(c)?c:b}},autoIncrement:function(){var a=0;return function(b){return null!==b?b:++a}},custom:function(a){return function(b){return a(b)}},number:function(b){return function(c){return null===c?null:a.isDefined(c)?+c:b}},string:function(b){return function(c){return null===c?b||null:a.isDefined(c)?String(c):b}}},f={TYPES:{ONE:"One",MANY:"Many"},One:function(a){this.getOptions=function(){return a}},Many:function(a){this.getOptions=function(){return a}}};c.service("catwalk",["$rootScope","$q","$interpolate","Crossfilter",function(c,g,h,i){function j(){this.collections={}}return j.prototype={mode:"instant",collections:{},primaryName:"_catwalkId",silent:!1,eventName:"catwalk/{{type}}/{{collection}}",attribute:e,relationship:{hasOne:function(a){return new f[f.TYPES.ONE](a)},hasMany:function(a){return new f[f.TYPES.MANY](a)}},collection:function(a,b){return this.collections[a]||(this.collections[a]=new i([],this.primaryName)),b&&(b[this.primaryName]=this.attribute.number(),this.collections[a].blueprint=b,this.collections[a].index=0,this.collections[a].name=a,this._propertyIterator(b,function(b){this.collections[a].addDimension(b)})),this.collections[a]},setMode:function(a){this.mode=a},silently:function(a){this.silent=!0,a.apply(this),this.silent=!1},createModel:function(a,b){b=this.cleanModel(a,b);var c=this.simplifyModel(a,b),d=this.createPromise(a,"create",[c]);return d.then(this.resolveCreateModel(a,b).bind(this)),d.catch(this.rejectCreateModel(a,b).bind(this)),b},resolveCreateModel:function(b,c){return function(d){var e=this.collection(b).blueprint;this._propertyIterator(d,function(b){var f=e[b];a.isDefined(f)&&(c[b]=f(d[b]))}),this.collection(b).addModel(c)}},rejectCreateModel:function(a,b){return function(){this.silently(function(){this.collection(a).deleteModel(b)})}},updateModel:function(a,c,d){var e=b.extend(b.clone(c),d),f=this.simplifyModel(a,e),g=this.createPromise(a,"update",[f]);return g.catch(this.rejectUpdateModel(a,c,e).bind(this)),g.then(this.resolveUpdateModel(a,e,c,d).bind(this)),c},resolveUpdateModel:function(a,b,c){return function(){this.silently(function(){this.createModel(a,b),this.deleteModel(a,c)})}},rejectUpdateModel:function(a,b,c){return function(){this.silently(function(){return[a,b,c]})}},resolveReadModel:function(a){return function(b){this.silently(function(){this.createModel(a,b)})}},deleteModel:function(a,b){var c=this.simplifyModel(a,b),d=this.createPromise(a,"delete",[c]);return d.then(this.resolveDeleteModel(a,b).bind(this)),d.catch(this.rejectDeleteModel(a,b).bind(this)),b},resolveDeleteModel:function(a,b){return function(){this.collection(a).deleteModel(b)}},rejectDeleteModel:function(a,b){return function(){this.silently(function(){this.collection(a).restoreModel(b)})}},simplifyModel:function(a,c){var d=b.clone(c);return delete d[this.primaryName],delete d.$$hashKey,d},createPromise:function(a,d,e){var f=g.defer();if(this.silent)return f.resolve(),f.promise;b.isArray(e)||(e=e?[e]:[]),e.unshift(f);var i=h(this.eventName)({type:d,collection:a});return c.$broadcast(i,e[0],e[1],e[2]),f.promise},throwRelationshipException:function(){d("Congratulations! You managed to create an invalid relationship")},cleanModel:function(b,c){var d=this.primaryName,e=this.collection(b).blueprint,f=this._propertyIterator,g=this.relationshipType.bind(this);return c[d]=++this.collection(b).index,function(){f(c,function(a){e.hasOwnProperty(a)||delete c[a]})}(),function(){f(e,function(f){if(a.isDefined(c[f])||f===d||(c[f]=null),!g(b,f)){var h=e[f];return void(c[f]=h(c[f]))}})}(),c},relationshipType:function(a,b){var c=this.collection(a).blueprint[b],d={};d[f.TYPES.ONE]=f.One,d[f.TYPES.MANY]=f.Many;for(var e in d)if(d.hasOwnProperty(e)&&c instanceof d[e])return e;return null},_propertyIterator:function(a,b){for(var c in a)a.hasOwnProperty(c)&&b.call(this,c)}},new j}])}(window.angular,window._);